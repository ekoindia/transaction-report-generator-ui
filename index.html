<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Report Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ffb218;
            --light-gray: #F8F9FA;
            --medium-gray: #6C757D;
            --dark-gray: #343A40;
            --border-color: #DEE2E6;
            --input-border-color: #ced4da;
            --white: #FFFFFF;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .page-header {
            background-color: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .logo img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .header-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--dark-gray);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .main-content {
            padding: 2.5rem;
        }

        .form-container {
            max-width: 850px;
            background: var(--white);
            border-radius: 12px;
            margin: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .form-body {
            padding: 2rem 2.5rem;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.75rem;
            margin-bottom: 1.75rem;
        }

        .form-group {
            flex: 1 1 100%;
            min-width: 250px;
            margin-bottom: 1.75rem;
            /* Consistent spacing */
        }

        /* ✨ FIX: Removes the 'double margin' on two-column rows */
        .form-row .form-group {
            margin-bottom: 0;
        }

        /* Remove margin from last group in the form */
        .form-body>.form-group:last-of-type,
        .form-body>.form-row:last-of-type {
            margin-bottom: 0;
        }


        label {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.6rem;
            font-size: 0.875rem;
            /* 14px */
            color: #495057;
        }

        label svg {
            width: 16px;
            height: 16px;
            color: var(--medium-gray);
        }

        input,
        select {
            width: 100%;
            padding: 0.8rem;
            border-radius: 6px;
            border: 1px solid var(--input-border-color);
            box-sizing: border-box;
            font-size: 0.95rem;
            background: var(--white);
            transition: border-color 0.2s, box-shadow 0.2s;
            color: var(--dark-gray);
            font-family: 'Inter', sans-serif;
        }

        input::placeholder,
        select {
            color: #adb5bd;
        }

        input[type="datetime-local"] {
            color-scheme: light;
        }

        input:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3.5px rgba(37, 99, 235, 0.15);
        }

        .radio-group-label {
            margin-bottom: 0.75rem;
        }

        .radio-group {
            display: flex;
            gap: 24px;
            /* Increased gap */
            margin-bottom: 1rem;
        }

        .radio-group label {
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            gap: 0.6rem;
            margin-bottom: 0;
        }

        input[type="radio"] {
            display: none;
        }

        input[type="radio"]+span {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--input-border-color);
            position: relative;
            transition: all 0.2s;
            background: #fff;
        }

        input[type="radio"]:checked+span {
            border-color: var(--primary-color);
        }

        input[type="radio"]:checked+span::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }

        .admin-code-input-wrapper {
            margin-top: 0.75rem;
            /* Added positive margin */
        }

        button[type="submit"] {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            padding: 0.9rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 1.75rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
        }

        button[type="submit"]:hover {
            background-color: #1D4ED8;
        }

        #message {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .error {
            background-color: #FEE2E2;
            color: #B91C1C;
        }

        .success {
            background-color: #D1FAE5;
            color: #065F46;
        }

        #agentTypeGroup {
            display: none;
        }
    </style>
</head>

<body>
    <header class="page-header">
        <img src="https://eko.in/assets/img/eko-logo.svg" alt="Eko Logo"
            style="height: 48px; width: 48px; object-fit: contain;">
        <span style="font-size: 0.875rem;">Transaction Report Generator</span>
    </header>

    <main class="main-content">
        <div class="form-container">
            <div class="form-body">
                <div id="message"></div>
                <form id="n8nForm">

                    <div class="form-group">
                        <label for="access_password">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                            </svg>
                            Access Password
                        </label>
                        <input type="password" id="access_password" required maxlength="12"
                            placeholder="12-character password with special character">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="start_date">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 15.75h.008v.008H12v-.008Z" />
                                </svg>
                                Start Date
                            </label>
                            <input type="datetime-local" id="start_date" required>
                        </div>
                        <div class="form-group">
                            <label for="end_date">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 15.75h.008v.008H12v-.008Z" />
                                </svg>
                                End Date
                            </label>
                            <input type="datetime-local" id="end_date" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
                                </svg>
                                Email <span style="color: #888; font-size: 0.95em;">(only @eko.co.in allowed)</span>
                            </label>
                            <div style="display: flex; align-items: center; gap: 0.5em;">
                                <input type="text" id="email_local" required placeholder="yourname" style="flex:1;"
                                    autocomplete="off" pattern="^[^@]+$">
                                <span style="font-size: 1em; color: #555;">@eko.co.in</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="user_name">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                                </svg>
                                Username
                            </label>
                            <input type="text" id="user_name" required placeholder="Enter username">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="department_name">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6h1.5m-1.5 3h1.5m-1.5 3h1.5M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" />
                            </svg>
                            Department Name
                        </label>
                        <input type="text" id="department_name" required placeholder="Enter department name">
                    </div>

                    <div class="form-group">
                        <label class="radio-group-label">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9.594 3.94c.09-.542.56-1.003 1.11-1.226a2.25 2.25 0 0 1 2.593 1.226c.553.991.687 2.183.424 3.285l-1.396 5.586a1.125 1.125 0 0 0 .373 1.254l.093.093a1.125 1.125 0 0 0 1.591 0l.093-.093a1.125 1.125 0 0 0 .373-1.254l-.27-1.082a2.25 2.25 0 0 1 .98-2.316l.27-.135a2.25 2.25 0 0 1 2.316.98l1.082.27a1.125 1.125 0 0 0 1.254-.373l.093-.093a1.125 1.125 0 0 0 0-1.591l-.093-.093a1.125 1.125 0 0 0-1.254-.373l-1.082.27a2.25 2.25 0 0 1-2.316-.98l-.135-.27a2.25 2.25 0 0 1 .98-2.316l5.586-1.396c1.102-.263 2.294-.13 3.285.424a2.25 2.25 0 0 1 1.226 2.593c-.223.55-.684 1.02-1.226 1.11l-5.586 1.396a1.125 1.125 0 0 0-.373 1.254l.093.093a1.125 1.125 0 0 0 1.591 0l.093-.093a1.125 1.125 0 0 0 .373-1.254l1.396-5.586c.263-1.102.13-2.294-.424-3.285a2.25 2.25 0 0 1-1.226-2.593c-.55-.99-1.602-1.544-2.593-1.226l-5.586 1.396a1.125 1.125 0 0 0-1.254.373l-.093.093a1.125 1.125 0 0 0 0 1.591l.093.093a1.125 1.125 0 0 0 1.254.373l1.082-.27a2.25 2.25 0 0 1 2.316.98l.27.135a2.25 2.25 0 0 1-.98 2.316l-1.396 5.586c-1.102.263-2.294.13-3.285-.424A2.25 2.25 0 0 1 3.94 9.594l1.396-5.586Z" />
                            </svg>
                            Admin Code Selection
                        </label>
                        <div class="radio-group">
                            <label><input type="radio" name="admin_option" value="code" checked><span></span>By Admin
                                Code</label>
                            <label><input type="radio" name="admin_option" value="all"><span></span>All</label>
                        </div>
                        <div class="admin-code-input-wrapper">
                            <input type="text" id="admin_code" required placeholder="Enter admin code">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="transaction_type">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                                </svg>
                                Transaction Type
                            </label>
                            <select id="transaction_type" required></select>
                        </div>
                        <div class="form-group">
                            <label for="vertical">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                                </svg>
                                Vertical
                            </label>
                            <select id="vertical" required></select>
                        </div>
                    </div>

                    <div class="form-group" id="agentTypeGroup">
                        <label for="agent_type">Agent Type</label>
                        <select id="agent_type"></select>
                    </div>

                    <button type="submit">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" width="20" height="20">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Generate Report
                    </button>
                </form>
            </div>
        </div>
    </main>

    <script>
        // All Javascript remains the same as it correctly targets elements by their ID.
        // No changes are needed here for the functionality to work with the new design.

        const endpointMap = {
            indo_nepal: "https://example.com/webhook/indo_nepal",
            neobank: "https://automaton8n.eko.in/webhook-test/Neo_Raw_Data",
            dmt: "https://automaton8n.eko.in/webhook-test/DMT_Raw_Data",
            aeps_fund_settlement: "https://automaton8n.eko.in/webhook-test/PayoutDump"
        };

        const transactionTypeOptions = [
            { label: "Indo Nepal", value: "indo_nepal" },
            { label: "Aeps withdrawl", value: "aeps_withdrawl" },
            { label: "Aeps Mini Statement", value: "aeps_mini_statement" },
            { label: "Credit Card Bill Payment", value: "credit_card_bill_payment" },
            { label: "AePs Fund Settlement", value: "aeps_fund_settlement" },
            { label: "NeoBank", value: "neobank" },
            { label: "Account Verification", value: "account_verification" },
            { label: "DMT", value: "dmt" },
            { label: "BBPS", value: "bbps" },
            { label: "Airtel CMS", value: "airtel_cms" },
            { label: "PG", value: "pg" },
            { label: "QR", value: "qr" }
        ];

        const verticalOptions = [
            { label: "EPS", value: "EPS" },
            { label: "Eloka", value: "Eloka" },
            { label: "Connect", value: "Connect" }
        ];

        const agentTypeOptions = {
            Eloka: [
                { label: "Admin & Network", value: "admin_network" },
                { label: "Individual", value: "individual" }
            ],
            Connect: [
                { label: "Individual", value: "individual" },
                { label: "Distributor's Network", value: "distributors_network" }
            ]
        };

        function renderOptions(selectEl, options, placeholderText = `Select an option`) {
            selectEl.innerHTML = `<option value="" disabled selected>${placeholderText}</option>`;
            options.forEach(opt => {
                const optionEl = document.createElement("option");
                optionEl.value = opt.value;
                optionEl.text = opt.label;
                selectEl.appendChild(optionEl);
            });
        }

        function getCurrentDateTimeLocal() {
            const now = new Date();
            now.setSeconds(0, 0);
            const pad = n => String(n).padStart(2, '0');
            return `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
        }

        document.addEventListener('DOMContentLoaded', function () {
            renderOptions(document.getElementById("transaction_type"), transactionTypeOptions, 'Select Transaction Type');
            renderOptions(document.getElementById("vertical"), verticalOptions, 'Select Vertical');

            const now = getCurrentDateTimeLocal();
            document.getElementById("end_date").value = now;
            document.getElementById("end_date").max = now;
            document.getElementById("start_date").max = now;

            // Hide message div initially
            document.getElementById("message").style.display = 'none';
        });

        document.getElementById("vertical").addEventListener("change", function () {
            const vertical = this.value;
            const showAgent = document.querySelector('input[name="admin_option"]:checked').value === 'code';

            if (agentTypeOptions[vertical] && showAgent) {
                renderOptions(document.getElementById("agent_type"), agentTypeOptions[vertical], 'Select Agent Type');
                document.getElementById("agentTypeGroup").style.display = "block";
                document.getElementById("agent_type").required = true;
            } else {
                document.getElementById("agentTypeGroup").style.display = "none";
                document.getElementById("agent_type").innerHTML = "";
                document.getElementById("agent_type").required = false;
            }
        });

        document.querySelectorAll('input[name="admin_option"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const isAll = this.value === 'all';
                const adminInput = document.getElementById("admin_code");

                adminInput.value = isAll ? "ALL" : "";
                adminInput.disabled = isAll;
                adminInput.required = !isAll;

                if (isAll) {
                    document.getElementById("agentTypeGroup").style.display = "none";
                    document.getElementById("agent_type").innerHTML = "";
                    document.getElementById("agent_type").required = false;
                } else {
                    const vertical = document.getElementById("vertical").value;
                    if (agentTypeOptions[vertical]) {
                        renderOptions(document.getElementById("agent_type"), agentTypeOptions[vertical], 'Select Agent Type');
                        document.getElementById("agentTypeGroup").style.display = "block";
                        document.getElementById("agent_type").required = true;
                    }
                }
            });
        });

        document.getElementById("n8nForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const messageEl = document.getElementById("message");
            messageEl.style.display = 'none';
            messageEl.className = '';


            // ✅ Password Validation
            const password = document.getElementById("access_password").value;
            const passwordPattern = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{12}$/;
            const allowedPassword = "eko@123abcX!";

            if (!passwordPattern.test(password) || password !== allowedPassword) {
                messageEl.innerHTML = "Unauthorized: Incorrect or invalid password format.";
                messageEl.classList.add('error');
                messageEl.style.display = 'block';
                return;
            }

            const formatDateTime = dt => dt ? dt.replace("T", " ") + ":00" : '';
            const isAll = document.querySelector('input[name="admin_option"]:checked').value === 'all';

            // Get the local part and build the email
            const emailLocal = document.getElementById("email_local").value.trim();
            const email = emailLocal ? emailLocal + "@eko.co.in" : '';

            const data = {
                start_date: formatDateTime(document.getElementById("start_date").value),
                end_date: formatDateTime(document.getElementById("end_date").value),
                email: email,
                user_name: document.getElementById("user_name").value,
                department_name: document.getElementById("department_name").value,
                admin_code: isAll ? "ALL" : document.getElementById("admin_code").value,
                transaction_type: document.getElementById("transaction_type").value,
                vertical: document.getElementById("vertical").value,
                agent_type: !isAll && document.getElementById("agentTypeGroup").style.display === "block"
                    ? document.getElementById("agent_type").value
                    : null
            };

            // Only allow non-empty local part, and must be a valid local part (no @ allowed)
            if (!emailLocal.match(/^[A-Za-z0-9._%+-]+$/)) {
                messageEl.innerHTML = "Please enter a valid email local part (before @eko.co.in), without @.";
                messageEl.classList.add('error');
                return;
            }

            try {
                const endpoint = endpointMap[data.transaction_type];

                if (!endpoint) {
                    messageEl.innerHTML = "No endpoint configured for this transaction type.";
                    messageEl.classList.add('error');
                    messageEl.style.display = 'block';
                    return;
                }

                const res = await fetch(endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    messageEl.innerHTML = "Report generated successfully. Check your inbox.";
                    messageEl.classList.add('success');
                    messageEl.style.display = 'block';

                    document.getElementById("n8nForm").reset();
                    document.getElementById("agentTypeGroup").style.display = "none";
                    document.getElementById("admin_code").disabled = false;

                    const now = getCurrentDateTimeLocal();
                    document.getElementById("end_date").value = now;
                    document.getElementById("end_date").max = now;
                    document.getElementById("start_date").max = now;
                } else {
                    messageEl.innerHTML = "Something went wrong. Please try again.";
                    messageEl.classList.add('error');
                    messageEl.style.display = 'block';
                }
            } catch (err) {
                console.error(err);
                messageEl.innerHTML = "Network error. Please check your connection.";
                messageEl.classList.add('error');
                messageEl.style.display = 'block';
            }
        });

        const emailInput = document.getElementById("email_local");
        emailInput.addEventListener("input", function (e) {
            // Prevent user from typing '@' or any part of the domain
            if (this.value.includes("@")) {
                this.value = this.value.replace(/@.*/, "");
            }
        });
    </script>
</body>

</html>